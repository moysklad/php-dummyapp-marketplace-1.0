# Демо-приложение на PHP для Маркетплейса МоегоСклада

Демо-приложение предназначено для демонстрации взаимодействия приложений с Маркетплейсом МоегоСклада. 

В демо-приложении реализованы следующие функции:
* Активация (с получением токена доступа к JSON API 1.2) и деактивация по Vendor API
* Использование iframe для настройки приложения администратором аккаунта с обновлением статуса в Маркетплейсе
* Получение контекста пользователя для iframe (отображение информации по пользователю, проверка прав администратора)
* Получение информации из МоегоСклада по JSON API 1.2 с доступом по токену
* Встраивание виджетов в карточку Контрагента, Заказ покупателя и Отгрузку

ВНИМАНИЕ! Демо-приложение предназначено для ознакомления с функционалом Маркетплейса МоегоСклада и вопросы 
безопасности и стабильности его работы не рассматривались в рамках его разработки.

## Виджеты

Приложение встраивает виджеты на следующие экраны:

* Контрагент (entity.counterparty.view)
* Заказ покупателя (document.customerorder.edit)
* Отгрузка (document.demand.edit)

Цель данных виджетов - продемонстрировать, как работает система виджетов в UI МоегоСклада. 

Все виджеты работают одинаково и реализуют следующие функции:
* Отображение текущего пользователя (демонстрация получения контекста пользователя по contextKey)
* Получение данных об открытой сущности/документе через JSON API
* Возможность управления задержкой отправки сообщения OpenFeedback (демонстрация работы протокола open-feedback)
* Возможность посмотреть границы и размеры содержимого виджета
* Лог JavaScript-сообщений (`Window.postMessage`): входящих от хост-окна и исходящих от виджета  

Обратите внимание, что геометрические свойства DOM-элементов типа `scrollHeight` равны 0 или null до момента снятия заглушки 
в хост-окне (так работают браузеры) - например, в обработчике входящего сообщения `Open` и даже после отправки сообщения `OpenFeedback`. 
Если виджет не поддерживает опциональный протокол `open-feedback`, то заглушка при открытии виджета не ставиться и геометрические
свойства должны работать уже при получении сообщения `Open`.   

## Настройка (конфигурирование) приложения

Перед использованием приложения нужно настроить следующие конфигурационные параметры:

* `appId`                           - идентификатор приложения в Маркетплейсе
* `appUid`                          - appUid приложения в  в Маркетплейсе
* `secretKey`                       - секретный ключ для подписи JWT
* `appBaseUrl`                      - базовый URL приложения, должен указывать на содержимое `./src/php` (сейчас используется при генерации дескриптора)

Для настройки конфигурационных параметров нужно скопировать файл `config.tpl.php` в файл `config.php` 
и указать ваши актуальные значения в файле `config.php`.

## Структура файлов приложения

### Основные файлы приложения

* `config.php`                      - текущая конфигурация
* `config.tpl.php`                  - заготовка файла конфига
* `iframe.html.php`                 - HTML-шаблон содержимого iframe
* `iframe.php`                      - контроллер отображения содержимого iframe
* `jwt.lib.php`                     - JWT PHP библиотека (копипаст из https://github.com/firebase/php-jwt)
* `lib.php`                         - общие классы приложения (конфигурация, модели данных, врапперы доступа к АПИ МоегоСклада)
* `update-settings.php`             - контроллер обновления настроек
* `user-context-loader.inc.php`     - общий код получения контекста пользователя через Vendor API (используется главным iframe приложения и виджетами) 
* `vendor-endpoint.php`             - контроллер REST-endpoint'a Vendor API на стороне вендора

### Файлы виджетов

* `widgets/counterparty-widget.php`     - контроллер виджета в карточке Контрагента (entity.counterparty.view)
* `widgets/customerorder-widget.php`    - контроллер виджета в Заказе покупателя (document.customerorder.edit)
* `widgets/demand-widget.php`           - контроллер виджета в Отгрузке (document.demand.edit)
* `widgets/widget.html.php`             - HTML-шаблон содержимого виджета с javascript-кодом взаимодействия виджета с хост-окном
* `widgets/widget.inc.php`              - общий код контроллеров виджетов

### Утилиты

В комплекте с приложением идут два утилитных скрипта:

* `utils/generate-descriptor.php`     - генерация дескриптора приложения в соответствии с текущей конфигурацией
* `utils/generate-jwt.php`            - генерация JWT-токена (например, для выполнения запросов через Postman) 

### Логи

Логи записываются в файл `logs/log.txt`

### Данные

Состояние приложений хранится в файловой системе (сериализацией) по одному файлу на каждый экземпляр приложения в `data/*.app` 
